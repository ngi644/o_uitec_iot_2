# IoTシステムの構築とその応用(2)



# ローカルDatabaseの利用

ローカルデータベースを利用することで，インターネットに接続できない環境でもデータの保存・管理が可能となります．

ここでは，MariaDBを利用して，ローカルデータベースを構築し，Node-REDからデータベースの操作を行います．


## node-red-node-mysqlのインストール

Node-REDのパッケージマネージャを利用して，MySQLデータベースの操作を行うためのパッケージをインストールします．

`node-red-node-mysql` を検索し，インストールします．

- https://flows.nodered.org/node/node-red-node-mysql


## Raspberry Pi 5 へ　MySQLデータベースのセットアップ

### aptコマンドでインストールします

```bash
sudo apt update
sudo apt install -y mariadb-server
```

### mysql_secure_installation　コマンドを実行して，rootユーザのパスワードを設定します

対話式で設定を行います．

```bash
sudo mariadb-secure-installation
```

#### 設定項目は以下の通りです

```bash
Enter current password for root (enter for none):  <- そのままEnter
Switch to unix_socket authentication [Y/n]:        <- n
Change the root password? [Y/n]:                   <- y
New password:                                      <- MariaDBのrootユーザー用パスワードを新規作成
Re-enter new password:                             <- 
Remove anonymous users? [Y/n]:                     <- y
Disallow root login remotely? [Y/n]:               <- n
Remove test database and access to it? [Y/n]:      <- y
Reload privilege tables now? [Y/n]:                <- y
```

### rootユーザでログインします

```bash
sudo mysql -u root -p
```

### testデータベースを作成します．

```sql
MariaDB [(none)]> CREATE DATABASE test;
```

### Node-REDでのMySQLデータベースの操作を行うためのサンプルFlow

- https://flows.nodered.org/flow/6ff5ddb1ac337da8fd45b2ad5914a48a


## サンプルFlowの動作確認

### Flowのインポート

Node-REDのメニューから，インポートを選択し，以下のFlowをインポートします．

```json
[
    {
        "id": "dbb1e4f8.5c3a",
        "type": "mysql",
        "z": "7e85d531f9394536",
        "mydb": "8f4e2c1d.3b2f7a",
        "name": "",
        "x": 330,
        "y": 580,
        "wires": [
            [
                "7c9e4f8a.5d3a"
            ]
        ]
    },
    {
        "id": "7c9e4f8a.5d3a",
        "type": "debug",
        "z": "7e85d531f9394536",
        "name": "DB Result",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "payload",
        "targetType": "msg",
        "x": 490,
        "y": 580,
        "wires": []
    },
    {
        "id": "c9e4f8a.5d3a",
        "type": "inject",
        "z": "7e85d531f9394536",
        "name": "Select Data",
        "props": [
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "SELECT NOW() AS current_time;",
        "x": 170,
        "y": 580,
        "wires": [
            [
                "dbb1e4f8.5c3a"
            ]
        ]
    },
    {
        "id": "8f4e2c1d.3b2f7a",
        "type": "MySQLdatabase",
        "name": "",
        "host": "localhost",
        "port": "3306",
        "db": "test",
        "tz": "",
        "charset": ""
    },
    {
        "id": "ccad32b0c9311d51",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-node-mysql": "2.0.0"
        }
    }
]
```

### MySQLノードの設定

MySQLノードをダブルクリックして，設定画面を開きます．
- `Database` 項目の鉛筆アイコンをクリックして，データベースの設定を行います．
  - `Host` : `localhost`
  - `Port` : `3306`
  - `Database` : `test`
  - `User` : `root`
  - `Password` : (先ほど設定したrootユーザのパスワード) 
- `Save` ボタンをクリックして，設定を保存します．

### SQLクエリの設定

インジェクトノードの設定画面内の `msg.topic` 項目に以下のSQLクエリを入力します．

```sql
    SELECT NOW() AS current_time;
```

### 動作確認

`Select Data` インジェクトノードの左側の四角いボタンをクリックして，Flowを実行します．
MySQLノードが実行され，`DB Result` デバッグノードに以下の様なメッセージが表示されれば成功です．

```json
[{"current_time":"2025-01-23 12:34:56"}]
``` 


## リファレンス
- MariaDB公式サイト
  - https://mariadb.com/
- node-red-node-mysql
  - https://flows.nodered.org/node/node-red-node-mysql



