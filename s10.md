# IoTシステムの構築とその応用(2)


# NASを用いたローカルIoTシステムの構築

### NASの概要

NAS(Network Attached Storage)は，ネットワークに接続されたストレージ装置のことです．
NASは，ネットワーク上の複数のデバイスからアクセス可能であり，ファイル共有やバックアップ，データの集中管理などに利用されます．

### 利用するNAS

本演習では，QNAP社のNASを利用しています．
QNAP社のNASは，ただのファイルサーバーではなく，様々なアプリケーションをインストールして利用することができます．

今回は，以下のアプリケーションを利用します．
- Virtualization Station

### Virtualization Station

Virtualization Stationは，QNAPのNAS上で仮想マシンを作成，管理するためのアプリケーションです．



## モニタリングIoTシステムの構築

### 概要

本演習では，Zabbixを利用して，モニタリングIoTシステムを構築します．
Zabbixは，オープンソースの監視プラットフォームであり，様々なIoTデバイスを統合して監視することができます．
ZabbixをQNAPのNAS上に構築し，IoTデバイスと連携させることで，モニタリングIoTシステムを構築します．

### ログイン

Zabbixのログイン画面に管理者としてアクセスします．
- URL: http://\[ZabbixのIPアドレス\]

#### ユーザー名とパスワード
- username: Admin
- password: zabbix


### ホストの追加

ZabbixにIoTデバイスをホストとして追加します．
1. メニューから「Monitoring」->「Hosts」を選択します．
2. 「Create Host」ボタンをクリックします．
3. ホスト名，グループの情報を入力します．
4. 「追加」ボタンをクリックしてホストを作成します

### アイテムの追加
ホストに監視したいアイテムを追加します．
1. ホストの詳細画面で「Items」タブを選択します．
2. 「Create Item」ボタンをクリックします．
3. アイテム名，タイプ，キー，更新間隔などの情報を入力します．
4. 「追加」ボタンをクリックしてアイテムを作成します


### ダッシュボードの作成
監視結果を可視化するために，ダッシュボードを作成します．
1. メニューから「ダッシュボード」->「新しいダッシュボード」を選択します．
2. ウィジェットを追加して，監視結果を表示します．
3. ダッシュボードのレイアウトやデザインをカスタマイズします．
4. 「保存」ボタンをクリックしてダッシュボードを保存します

## Node-REDとの連携

ZabbixとNode-REDを連携させることで，IoTデバイスの監視データをリアルタイムで処理・分析できます．
### Node-REDにZabbixノードをインストール

Node-REDのパッケージマネージャを利用して，Zabbixへテレメトリ送信を行うためのパッケージをインストールします．

`node-red-contrib-zabbix-sender` を検索し，インストールします．

### Node-REDフローの作成

以下のフローをインポートします．

'''json
[
    {
        "id": "07ce783ce4f8adfa",
        "type": "inject",
        "z": "61b354091f9f9ead",
        "name": "",
        "props": [
            {
                "p": "payload"
            },
            {
                "p": "topic",
                "vt": "str"
            }
        ],
        "repeat": "10",
        "crontab": "",
        "once": false,
        "onceDelay": 0.1,
        "topic": "",
        "payload": "",
        "payloadType": "date",
        "x": 200,
        "y": 540,
        "wires": [
            [
                "58fc3ef067e39fe6"
            ]
        ]
    },
    {
        "id": "c62f5d08f0f5cbf7",
        "type": "zabbix-sender",
        "z": "61b354091f9f9ead",
        "zabbixServer": "192.168.0.11",
        "zabbixPort": 10051,
        "sendTimestamps": false,
        "withNs": false,
        "timeout": "1000",
        "defaultHostname": "teacher1",
        "x": 620,
        "y": 540,
        "wires": []
    },
    {
        "id": "58fc3ef067e39fe6",
        "type": "function",
        "z": "61b354091f9f9ead",
        "name": "function 1",
        "func": "function getRandomArbitrary(min, max) {\n  return Math.random() * (max - min) + min;\n}\n\nlet temp = getRandomArbitrary(0, 30); \n\nmsg.payload = [\"IoT\", \"temp\", temp];\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 420,
        "y": 540,
        "wires": [
            [
                "c62f5d08f0f5cbf7"
            ]
        ]
    },
    {
        "id": "7a4f98b2719face7",
        "type": "global-config",
        "env": [],
        "modules": {
            "node-red-contrib-zabbix-sender": "1.0.0"
        }
    }
]
'''






### リファレンス 
- QNAP Virtualization Station
  - https://www.qnap.com/solution/virtualization_station/ja/
- Zabbix Documentation
  - https://www.zabbix.com/documentation/current/ja/manual


---
